---
title: "プロンプトの「内容」だけでなく「書式」も同時に最適化する手法 Microsoftなどが開発"
source: "https://ai-data-base.com/archives/86402"
author:
  - "[[AIDB Research]]"
published: 2025-03-19
created: 2025-06-13
description: "本記事では、LLMのプロンプトを「内容」と「書式」の両面から最適化する新しい手法を紹介します。"
tags:
  - "clippings"
---
**【お知らせ】** AIDB主催のビジネスマッチングイベントを7月25日(金)開催予定です！  
  

\---以下、記事本文---

本記事では、LLMのプロンプトを「内容」と「書式」の両面から最適化する新しい手法を紹介します。

従来の手法は内容のみを対象としてきましたが、実は書式のわずかな違いによってもモデルの性能が大きく左右されることが最近の研究で判明しています。そこで、内容と書式を一体的に調整する方法が開発されました。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402-1024x576.png)

参照論文情報は記事の下部に記載されています。

**本記事の関連研究**

- [LLMはシステムプロンプトをどれほど守れるか](https://ai-data-base.com/archives/86276)
- [LLMにおける「計画立案能力」を高めるプロンプト手法の新提案](https://ai-data-base.com/archives/82983)
- [三段論法でLLMの推論能力を高める　プロンプト手法の新提案](https://ai-data-base.com/archives/82746)

## 背景

LLMが実際の業務やタスクで真に効果を発揮するかどうかは、モデルへの「問いかけ方」、つまりプロンプトの設計に大きく左右されます。良いプロンプトはモデルの性能を引き出し、ユーザーが望む出力を効果的に得るための鍵となりますが、一方で、プロンプトを人手で最適化することには課題があります。

その課題とは、LLMがプロンプトの微妙な変化に非常に敏感であるという性質に起因しています。たとえば、同じ内容の質問であっても、言葉遣いや文の構成をわずかに変えるだけで、LLMが返す回答が大きく異なることがあります。

また、モデルごとに「好むプロンプト形式」が異なるという性質があり、あるモデルで高性能なプロンプトが別のモデルではうまく機能しないこともあります。そのため、人が事前に万能なプロンプトの形式を決めることは難しいです。

これまでの研究では、そのような課題を解決するために、自動的にプロンプトを最適化する手法が提案されてきました。しかし、多くはプロンプトの「内容」だけに焦点を当てており、プロンプトをどのような構造や形式で提示するかという「書式（フォーマット）」については十分な検討が行われてきませんでした。

プロンプトの内容と書式が密接に関わり合っており、これらを分けて考えることは実際には難しいことが最近の調査で明らかになっています。モデルごとの細かな特性に合わせてプロンプトを調整するには、内容と書式を一体的に最適化する手法が必要になっています。

そこで今回Microsoftなどの研究者らは、内容と書式を同時に最適化する新しい手法の開発に取り組みました。

なお、下記のリポジトリに公開されているため、実際に使用することが可能です。

[https://github.com/HenryLau7/CFPO](https://github.com/HenryLau7/CFPO)

## 内容と書式を一体的に最適化するプロンプト手法「CFPO」

LLMはプロンプトの内容だけでなく、その書式にも敏感に反応します。実際、内容がどれだけ適切であっても、書式のちょっとした違いによってモデルの性能が大きく左右されることがあります。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_1.png)

プロンプトの書式がモデルごとの性能に与える影響、およびプロンプト内容と書式の複雑な相互関係を示した図

この現象はモデルごとに特有で、あるモデルでは有効だった書式が別のモデルではうまく機能しないこともしばしば見られます。こうした課題を踏まえると、内容だけでなく書式も同時に調整する必要があることが見えてきます。

従来の研究では主にプロンプトの内容を最適化する手法が探求されてきましたが、書式に関してはあまり本格的に検討されてきませんでした。Content-Format Integrated Prompt Optimization（CFPO）は、この課題に着目し、プロンプトの「内容」と「書式」をまとめて調整する方法を提案した手法です。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_2-1024x315.png)

提案手法（CFPO）における1回の最適化プロセスの流れを示した図

### CFPOの構成要素と基本的な考え方

CFPOは、プロンプトの最適化を行う際に「内容」と「書式」を別々にではなく、一体のものとして捉えます。ここでいう「内容」とは、プロンプトで実際にモデルに伝える言葉や例文、指示などのことを指します。

一方で、「書式」とは、それらをどのような構造で、どういう形式で提示するかということです。たとえば、同じ例文を提示するにしても、表形式で示すのか、箇条書きにするのか、あるいは特定の記号や区切りを使うか、といったことです。

プロンプトを最適化する作業は、実際には内容と書式が深く絡み合っており、どちらか一方だけを最適化しても限界があります。CFPOは、プロンプトの質を数値的に評価する基準を用いて、内容と書式の組み合わせをさまざまな方法で試しながら、最も優れた組み合わせを見つけようとします。

この評価基準は、モデルがどれくらい正確にタスクを解けるかを計測するもので、たとえば数学の問題を解くタスクでは正答率がその一例です。

CFPOの具体的な手法は、大きく二つの最適化手法を組み合わせています。

一つは内容に対する最適化で、モデルが間違えた例題やうまく解けた例題を細かく分析し、その診断をもとにプロンプトの内容を徐々に改善していく方式です。

もう一つは書式に対する最適化で、あらかじめ用意したさまざまな書式の候補から、性能の高い書式を自動的に探すという仕組みを採用しています。この際、モデルが自動的に新しい書式を提案し、その中から性能が良いものを繰り返し選んでいく方法を取っています。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_3-1024x404.png)

構造化プロンプトテンプレートの例示図。プロンプトを機能別の複数のコンポーネントに分割して示している

### 書式最適化の仕組み

#### 書式プールとスコアリング

CFPOでは、多様な書式の候補をあらかじめ「書式プール」として用意しています。書式プール内の書式候補は、「プロンプトレンダラー（Prompt Renderer）」と「クエリフォーマット（Query Format）」という二つの側面に整理されています。

プロンプトレンダラーはプロンプト全体の構造を定義し、クエリフォーマットは具体的な例や質問の提示方法を規定します。これらの候補をプロンプトごとに試して、その性能を定量的に評価し、スコアリングしていきます。

このスコアに基づいて、次に試すべき書式の優先順位を自動的に決定します。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_4-1024x523.png)

初期の書式プールに含まれる具体的な書式例とその表示効果を示した図

#### LLMを利用した書式生成

初期の書式プールだけでは書式の多様性に限界があるため、新しい書式を自動で生成する方法を導入しています。ここでは、LLM自体が、現在の書式プールを参考にしながら新たな書式を提案します。

たとえば、質問と回答の間に用いる区切り記号を変えたり、質問や回答の提示方法（大文字化、太字化など）を工夫したりすることで、新しい書式を生成します。こうした生成によって書式プールが随時更新され、多様性を維持しながら性能の高い書式を探索します。

#### 書式最適化の探索手法

CFPOは、プロンプトの書式を効率的に最適化するために、UCT（Upper Confidence bounds applied to Trees）という手法を活用しています。この手法は、「まだ試されていない書式」と「すでに性能が良いことが分かっている書式」とのバランスを取りながら、新たな書式を選択します。

つまり、ランダムに書式を選ぶのではなく、性能が高いと評価された書式と、新たに生成された書式をうまく組み合わせて試していくことで、効率よく最適な書式を見つけ出します。

各内容候補について、このUCTに基づく手法を用いて最適な書式を特定し、プロンプトの精度を継続的に向上させていく仕組みです。実際の評価結果によると、この探索手法を活用することで、ランダムに選ぶよりも明確に優れたプロンプトが得られることが示されています。

### プロンプトの「内容と書式」両方を同時に最適化する仕組み

CFPOは、プロンプトの「内容」と「書式」の両方を最適化するために、それぞれ別の最適化手法を同時に活用する統合的なアプローチを採用しています。内容の改善と書式の改善を完全に切り離して行うのではなく、両者の最適化を交互に繰り返すことで、最も効果的なプロンプトを徐々に絞り込んでいきます。

#### コンポーネントごとの内容最適化

CFPOではプロンプトの内容を最適化する際、「ケース診断」と「モンテカルロ [サンプリング](https://ai-data-base.com/archives/26518 "サンプリング") 」という二つの方法を組み合わせて用いています。「ケース診断」とは、実際にモデルが出力した結果を分析し、どの部分が問題だったのかを特定する方法です。

例えば、指定された出力形式に従っていない場合には、出力形式に関する指示文を修正します。

また、もう一つの方法であるモンテカルロ [サンプリング](https://ai-data-base.com/archives/26518 "サンプリング") では、プロンプト内の特定の表現を自然言語的に変化させることで、同じ意味を保ちながら内容に多様性をもたせます。この手法は偶然性を活用してさまざまな言い回しを生成し、モデルがどの表現で最もよく反応するかを見極める手段です。

こうして作られた多様な内容の候補から、特に性能が高いと評価されたものが次の書式最適化のステップに進みます。

### 書式最適化との統合プロセス

CFPOでは、前述した内容最適化を終えた後、書式の最適化を行います。この段階では、内容の最適化によって得られた候補ごとに、最も適切な書式を見つける作業を行います。

性能評価に基づくUCT手法を使って新しく生成した書式や既存の書式プールから最良の書式を探し出します。

内容と書式の最適化プロセスを交互に繰り返すことにより、書式の影響を十分に考慮した上で内容の最適化を進めることが可能になります。最適化の各段階では、評価スコアに基づき優れた候補のみが残り、これを繰り返すことでプロンプトの品質が段階的に向上します。

実験結果によれば、この統合的な最適化プロセスを採用することで、従来の内容のみに限定した最適化手法と比較して、明らかな性能向上が確認されました。書式を意識した最適化を組み合わせることで、モデルが出力する結果の精度が顕著に向上しています。詳しくは後述します。

## 実験によるCFPO検証

CFPOの有効性を明らかにするために、実際にさまざまなタスクやモデルを使った評価実験が行われました。実験の目的は、CFPOが異なる種類のモデルやタスクに対しても一貫して効果を発揮するかどうかを確かめることです。

### 実験の設定

評価には以下のような多岐にわたるタスクが選ばれました。数学的な推論を必要とする「GSM8K」や「MATH500」、選択肢から正しい答えを選ぶ必要があるARC-Challenge、分類タスクの一つであるBig-Benchなどが対象です。

これらは、数学的な推論能力、常識的な推論力、分類能力といった、多様な能力を測定できるよう設計されています。

また、評価に用いられたモデルには、基礎的な事前学習のみを行ったモデル（Mistral-7B-v0.1やLLaMA-3.1-8B）と、人間からの指示を受けて追加的にチューニングが施されたモデル（LLaMA-3-8B-InstructやPhi-3-Mini-Instruct）が含まれています。多様なモデルを選択した理由は、CFPOの手法が特定のモデルに偏らず、広く一般的に有効であるかどうかを調べるためです。

さらに、最適化プロセス自体の制御役として、GPT-4が採用されました。これはプロンプトの内容や書式を自動生成・評価する役割を担っています。各評価実験の具体的な設定として、各タスクごとのデータセットを利用し、プロンプトの改善プロセスを複数回繰り返してその性能を比較しました。

### 実験結果とその解釈

実験の結果、CFPOは従来の「内容のみを最適化する手法」と比較して、すべてのタスクとモデルにおいて一貫して高い性能を示しました。特に数学的な推論を求められるタスクでは、プロンプトの構造や書式に敏感であることから、CFPOによる性能向上が顕著でした。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_5.png)

CFPOを用いた評価実験において、他の手法との性能比較をタスク別・モデル別に示した表

また、特定の指示で調整されていない基礎的なモデルほど、CFPOによる最適化の効果がより明確に現れました。これは、プロンプトの書式を細かく調整することが、モデルの潜在能力を引き出す上で非常に重要であることを示しています。

### 各要素の影響に関する分析

CFPOの各構成要素がどれほど性能向上に貢献したのかを調べるために、

- 内容最適化のみを行った場合、
- 内容最適化後に書式最適化を追加した場合、そして
- 両方を完全に統合して行った場合

を比較しました。その結果、内容最適化と書式最適化を統合的に実施した場合が最も高い成果を出し、両要素の相互作用がプロンプト最適化に不可欠であることが確認されました。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_6-1024x345.png)

書式最適化の有無による性能差を示した表（アブレーション実験）

さらに、新しい書式を自動生成する仕組みやUCTを用いた探索手法が特に有効であり、最終的なプロンプトの性能向上に大きく寄与していることが明らかになりました。

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_7-1024x203.png)

新しい書式を生成する効果の有無を検証した実験結果を示す表

![](https://ai-data-base.com/wp-content/uploads/2025/03/AIDB_86402_8-1024x281.png)

UCTベースの書式選択方法と他の選択戦略（ランダム、貪欲法）の性能比較を示した表

## まとめ

本記事では、プロンプトの内容と書式を統合的に最適化する手法「CFPO」を紹介しました。

従来の内容重視の最適化とは異なり、書式の重要性にも着目していることが特徴です。実験結果では、内容と書式の双方を調整することで、モデルの性能が安定して向上することが確認されました。

書式を最適化するプロセスにおいて新たな探索手法が取り入れられている点が特に注目されます。

**参照文献情報**

- タイトル：Beyond Prompt Content: Enhancing LLM Performance via Content-Format Integrated Prompt Optimization
- URL： [https://doi.org/10.48550/arXiv.2502.04295](https://doi.org/10.48550/arXiv.2502.04295)
- 著者：Yuanye Liu, Jiahang Xu, Li Lyna Zhang, Qi Chen, Xuan Feng, Yang Chen, Zhongxin Guo, Yuqing Yang, Peng Cheng
- 所属：Fudan University Microsoft Research Asia

**■サポートのお願い  
**AIDBを便利だと思っていただけた方に、任意の金額でサポートしていただけますと幸いです。  

  

[APIベース vs GUIベース　LLMエージェントの使い分け](https://ai-data-base.com/archives/86923)

[エンジニアの個性やスタイルに合わせてLLMに説明の仕方を変えさせるのは有効か](https://ai-data-base.com/archives/86965)

 [![](https://ai-data-base.com/wp-content/themes/innovate_hack_tcd025/img/footer/return_top.png) PAGE TOP](https://ai-data-base.com/archives/#header_top)