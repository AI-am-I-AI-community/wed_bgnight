---
title: "LLMで因果推論を行うためのプロンプト手法"
source: "https://ai-data-base.com/archives/70145"
author:
  - "[[AIDB Research]]"
published: 2024-06-03
created: 2025-06-13
description: "因果推論とは、ある出来事が別の出来事にどのように影響するかを理解しようとする分析手法です。要するに「これをしたらあれが起きる」を予測するものです。"
tags:
  - "clippings"
---
**【お知らせ】** AIDB主催のビジネスマッチングイベントを7月25日(金)開催予定です！  
  

\---以下、記事本文---

因果推論とは、ある出来事が別の出来事にどのように影響するかを理解しようとする分析手法です。要するに「これをしたらあれが起きる」を予測するものです。そのような原因と結果の分析におけるLLMの有効性が日本国内における複数の大学からの研究グループにより研究されています。

![](https://ai-data-base.com/wp-content/uploads/2024/05/AIDB_70145-1024x576.jpg)

すべての実験パターンの統計的因果発見の結果の比較

**参照論文情報**

- タイトル：Integrating Large Language Models in Causal Discovery: A Statistical Causal Approach
- 著者：Masayuki Takayama, Tadahisa Okuda, Thong Pham, Tatsuyoshi Ikenoue, Shingo Fukuma, Shohei Shimizu, Akiyoshi Sannai
- 所属：Shiga University, Tokyo Medical University, Kyoto University, RIKEN, Hiroshima University, The University of Tokyo, National Institute of Informatics

## 背景

因果推論は医学、経済学、環境科学など様々な分野で利用されており、アルゴリズムは進歩しています。一方で、現象と仮定のミスマッチに起因した不正確さが課題となっています。また、系統的に整理されている実験データセットを得ることは難しく、使用されるデータセットはバイアスや測定誤差を含むものが多いと考えられています。

そんな中、状況はLLMの急速な進歩により変化してきました。LLMは知識豊富なので因果関係の客観的評価を行えると期待され、LLMを用いた知識ベースの因果推論は上手くいくとの報告がいくつか行われています。

しかし、LLMの学習データに含まれていないテーマにおいても性能が高いのかは不明です。

そこで日本の研究者らは、LLMを活用した因果発見の新しい方法論として、背景知識を考慮して分析するようLLMにプロンプトを与える手法「統計的因果プロンプティング」を考案しました。データセットのバイアスに対処でき、様々な分野で因果推論を行うことができるとされています。

![](https://ai-data-base.com/wp-content/uploads/2024/05/AIDB_70145_1-1024x697.jpg)

統計的因果プロンプティングの全体像

## 方法論

統計的因果探索（SCD）は、データから因果関係を自動的に見つける手法ですが、時には正しい因果関係を見落とすことがあります。そこで、膨大な背景知識を持つLLMとSCDの長所を組み合わせて、より正確な因果モデルを作るためのアルゴリズムが以下のように提案されました。

![](https://ai-data-base.com/wp-content/uploads/2024/05/AIDB_70145_2.png)

1. まず、SCDを使ってデータから因果関係の候補を見つけます。
2. 次に、その結果がどれだけ確からしいかを調べます。これがブートストラップ法です。
3. そして、データ内の全ての変数のペアについて、以下のことを行います
	- a. LLMに、SCDの結果や変数の情報を教えます。
	- b. LLMは、その情報を基に、因果関係についての知識を出力します。
	- c. LLMの出力を基に、もう一度LLMに質問します。
	- d. LLMの答えを複数回収集し、因果関係の確からしさを計算します。
4. 全ての変数のペアについて確からしさが計算できたら、それを事前知識として整理します。
5. 最後に、その事前知識を使ってSCDをもう一度行い、最終的な因果モデルを得ます。

今回、統計的因果探索手法には、オープンソースの「causal-learn」および「LiNGAM」で利用可能な3つのアルゴリズムが採用されました。

- PC algorithm
- Exact Search
- DirectLiNGAM

また、ブートストラップ再 [サンプリング](https://ai-data-base.com/archives/26518 "サンプリング") の回数は1000回に固定されています。

### LLMの条件とプロンプト

モデルにはGPT-4-1106-previewが採用されました。出力の確率分布を調整するためのハイパーパラメータである温度は0.7に固定されています。

知識生成のための最初のプロンプトテンプレートが下記に示されています。ゼロショットの思考連鎖（Zero-shot CoT）に基づいており、背景知識を引き出すことを目的としています。

![](https://ai-data-base.com/wp-content/uploads/2024/05/AIDB_70145_3.png)

変数xjからxiへの因果効果の専門家知識の生成に使用されるプロンプトテンプレート

プロンプトテンプレートの日本語訳：

```js
因果推論を実施したいと考えています。（空白1. テーマ）を考慮して、（空白2. すべての変数の説明）を変数として使用します。

まず、（空白3. SCDアルゴリズムの名前）を用いて統計的因果発見を行い、（空白4. データセットの説明）に基づいて完全に標準化されたデータセットを使用しました。

（空白5. ここにĜ0またはPの情報を含めます。内容の詳細はプロンプトパターンによって異なります。）

上記の結果によると、（空白6. ある/ない）の変化が（空白7. xjの名前）に直接影響を与える可能性があることが判明しました。（空白8. xiの名前）（空白9. 因果係数またはブートストラップ確率の値）。

次に、ドメイン知識の観点からこの結果を解釈し、この統計的に示唆された仮説がドメインの文脈で妥当かどうかを判断することがあなたの課題です。

（空白7. xjの名前）と（空白8. xiの名前）の因果関係についての専門知識を活用し、この因果発見結果の自然さを評価する説明を提供してください。関連要因を考慮し、ドメインの理解に基づいて合理的な説明を提供してください。
```

次に下記は、GPT-4に因果関係の有無を判断してもらうためのプロンプトのテンプレートを示しています。

![](https://ai-data-base.com/wp-content/uploads/2024/05/AIDB_70145_4.png)

変数xjからxiへの因果効果の存在に対するGPT-4の主張の確率の定量的評価に使用されるプロンプトテンプレート

このプロンプトでは、以下のようなことを行います。

1. まず、GPT-4に因果関係について詳しく説明してもらう
2. 次に、その説明を踏まえて、GPT-4に「この因果関係はあると思いますか?」と聞く
3. GPT-4は、「はい」か「いいえ」で答える
4. GPT-4が「はい」と答える確率を計算する

GPT-4の答えには少しばらつきがあるかもしれないので、同じ質問を何度か繰り返して、「はい」と答える確率の平均を取り、因果関係の有無を判断します。

プロンプトテンプレートの日本語訳：

```js
専門家に以下の質問がされました：
（空白10. q ij）
次に、専門家はそのドメイン知識で以下のように答えました：
（空白11. a ij）
上記の議論を客観的に考慮して、もし（空白12. xjの名前）が変更された場合、それは（空白13. xiの名前）に直接または間接的な影響を与えるでしょうか？
この質問に（yes）または（no）でお答えください。
この二つの回答以外の答えは必要ありません。
```

次に、GPT-4から得られた因果関係の確率を、統計的因果探索（SCD）で使えるようにするための手順が下記のアルゴリズム2です。

![](https://ai-data-base.com/wp-content/uploads/2024/06/AIDB_70145_5.png)

1. まず、GPT-4から得られた確率行列を用意します。  
	（各変数間の因果関係の確からしさを表しています）
2. 次に、因果関係を「禁止」と「強制」に分けるための基準を決めます。  
	（確率が0.05未満なら「禁止」、0.95以上なら「強制」としています。つまり、GPT-4が「ほぼ確実にない」と判断した因果関係は禁止し、「ほぼ確実にある」と判断した因果関係は強制するわけです）
3. SCDの手法によって、事前知識の与え方が少し違います。
	- Exact Searchでは、「強制」はできません。
	- DirectLiNGAMでは、因果関係に矛盾がないようにする必要があります
4. DirectLiNGAMで矛盾がある場合は、以下のようにします。
	- 特別な方法で、矛盾を取り除きます。
	- 矛盾を取り除く方法が複数ある場合は、なるべく良い方法を選びます

## 統計的因果プロンプティングの実験パターン

研究者らは、1つ目に挙げたプロンプトテンプレートの⟨blank 5⟩と⟨blank 9⟩に入れる情報を変えて、いくつかのSCPパターンを用いて実験を行いました。実験におけるプロンプトパターンの表記とその説明は以下の通りです。

### パターン0: SCPなし

他のSCPを含むパターンとの比較のための基準に相当します。

![](https://ai-data-base.com/wp-content/uploads/2024/06/AIDB_70145_B-1024x285.png)

### パターン1: 最初の統計的因果発見で現れた辺のリストを含む

変数xiとxjの間の因果関係を、矢印（→）または双方向の矢印（-）で表します。双方向の矢印は、どちらが原因でどちらが結果かわからない場合に使います。

### パターン2: SCDで見つかった因果関係とその確からしさをLLMに与える

パターン1の情報に加えて、各因果関係の確からしさ（ブートストラップ確率）も与えます。確からしさが0でない因果関係だけを教えます。

### パターン3: SCDで見つかった因果関係と因果の強さをLLMに与える(DirectLiNGAMのみ)

DirectLiNGAMというSCDの手法では、因果関係の強さ（因果係数）も計算できます。パターン1の情報に加えて、因果係数も与えることで、LLMの推論がより良くなるかを調べます。

### パターン4: SCDで見つかった因果関係、その確からしさ、因果の強さをLLMに与える(DirectLiNGAMのみ)

パターン2とパターン3の情報を両方与えます。つまり、LLMに与える情報量が最も多いパターンです。

SCDの結果をそのままLLMに伝えるだけでなく、確からしさや因果の強さも一緒に伝えることで、LLMがより正確に因果関係を判断できるようになるという仮説に基づいているようです。

### 実験用のデータセット

因果関係を発見するための手法を評価するには、正解（ground truth）がわかっているデータセットを使うのが良いとされています。そのようなデータセットをベンチマークデータセットと呼びます。

ただし、提案手法ではすべての変数が連続的であることを仮定しているため、カテゴリカル変数や離散変数を含むベンチマークデータセットは適していません。そこで、以下の3つの連続変数だけで構成されるベンチマークデータセットを選びました。

1. Auto MPGデータ（変数の数は5個）
2. ドイツ気象庁（DWD）の気候データ（変数の数は6個）
3. Sachsのタンパク質データ（変数の数は11個）

さらに、提案手法が以下のような場合でも有効かを確認するために、非公開の健康診断データも使います。

- GPT-4が事前に学習していないデータセットの場合
- データにバイアス（偏り）があり、そのままでは因果関係の発見が難しい場合

特に2つ目の場合を確認するために、健康診断データからバイアスが残ったサブセット（一部のデータ）を意図的に選んで使います。

## 実験結果

提案手法の性能を評価するために、構造的ハミング距離（SHD）、偽陽性率（FPR）、偽陰性率（FNR）、精度、 [F1スコア](https://ai-data-base.com/archives/26112 "F1スコア（F値）") などの指標が使われています。また、統計的な観点から、比較適合度指数（CFI）、 [平均二乗誤差](https://ai-data-base.com/archives/27022 "平均二乗誤差（MSE）") 平方根（ [RMSE](https://ai-data-base.com/archives/26358 "二乗平均平方根誤差（RMSE）") A）、ベイズ情報量規準（BIC）も評価されています。

![](https://ai-data-base.com/wp-content/uploads/2024/06/AIDB_70145_6-1-1024x622.jpg)

すべての実験パターンの統計的因果発見の結果の比較

すべての実験パターンの統計的因果発見の結果の比較

### GPT-4による事前知識の効果

多くの場合、GPT-4から得た事前知識を使うと、使わない場合よりも正解に近い結果が得られました。GPT-4が領域の専門家としての知識を提供し、因果関係の発見を助けているためだと考えられます。また、事前知識を使うことで、統計的な観点からも良い結果が得られることがわかりました。

### 変数の数の影響

変数の数が少ないデータセット（Auto MPG）では、事前知識を与える方法（プロンプトパターン）による性能の差は小さいです。一方、変数の数が多いデータセット（DWD、Sachs）では、プロンプトパターンによる性能の差が大きくなります。つまり、変数の数が多いほど、GPT-4にどのような情報を与えるかが重要になるということです。

### 因果関係の発見手法による違い

因果関係の発見手法（PC、Exact Search、DirectLiNGAM）によって、最適なプロンプトパターンが異なることがわかりました。例えば、DirectLiNGAMでは、統計的な情報（因果係数など）をGPT-4に与えることが有効です。ただし、与える情報が多すぎると、かえって性能が下がる場合もあります。

![](https://ai-data-base.com/wp-content/uploads/2024/06/AIDB_70145_8-1024x293.png)

健康診断データにおけるDirectLiNGAMの結果

### 事前学習していないデータでの結果

GPT-4が事前に学習していない健康診断データでも、提案手法が有効であることが確認されました。具体的には、GPT-4の知識を使うことで、データのバイアスによる悪影響を軽減できました。また、統計的な観点からも、GPT-4の知識を使った方が良い結果が得られました。

なおGPT-4にどのような情報を与えるかは、データセットや発見手法に応じて慎重に選ぶ必要があります。

![](https://ai-data-base.com/wp-content/uploads/2024/06/AIDB_70145_9-1024x292.png)

提案手法を用いた特定のバイアスを含む健康診断データのサブセットにおける統計的因果発見の特徴的な結果の定量的評価

## まとめ

本記事では、統計的因果発見とLLMを用いた知識ベースの因果推論を統合する新たな因果推論手法を提案した研究を紹介しました。

統計的因果プロンプティング（SCP）と事前知識拡張により、統計的因果発見の結果を改善できることが実験で明らかになりました。また、LLMの学習データに含まれていない実世界のデータセットでも有効性が示されています。

一方で、LLMの選択・活用方法の最適化やSCPの効果とデータセットの関係性など、いくつかの課題も残されています。このような手法は応用分野が広いため、今後の発展が期待されます。

- 参照論文URL： [https://arxiv.org/abs/2402.01454](https://arxiv.org/abs/2402.01454)

**■サポートのお願い  
**AIDBを便利だと思っていただけた方に、任意の金額でサポートしていただけますと幸いです。  

  

[LLMエージェントの認知バイアス](https://ai-data-base.com/archives/70084)

[グラフニューラルネットワークを活用したRAG手法『GNN-RAG』　7BのLLMでも最先端性能](https://ai-data-base.com/archives/70237)

 [![](https://ai-data-base.com/wp-content/themes/innovate_hack_tcd025/img/footer/return_top.png) PAGE TOP](https://ai-data-base.com/archives/#header_top)